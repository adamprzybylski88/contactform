const fs = require('fs')
const path = require('path')
const fileType = require('file-type')
const readChunk = require('read-chunk')

// function getDirectories(srcpath) {
// 	let ls = fs.readdirSync(srcpath)
//  let filePath = path.join(srcpath, file);
		
// 	return ls.filter(
// 		file => fs.statSync(
// 			filePath
// 		)
// 	.isDirectory()
// 	);
// }

module.exports = function listFiles(src) {

    var jpgArr          = [],
        pngArr          = [],
        pdfArr          = [],
        svgArr          = [],
        svgphArr        = [],
        psdArr          = [],
        gifArr          = [],
        vidArr          = [],
        fontsArr        = [],
        otherFilesArr   = [];

    function fromDir(_dir) {
        var files, files_l, fileName, filePath, stat, buf, _ext, fileSplit, _extName;

        if (!fs.existsSync(_dir)) {
            console.log("no dir ", _dir);
            return;
        }

        files = fs.readdirSync(_dir);
        files_l = files.length;

        for (var i = 0; i < files_l; i++) {
            fileName = files[i];
            filePath = path.join(_dir, fileName);
            stat = fs.lstatSync(filePath);

            if (stat.isDirectory()) {
                fromDir(filePath); // recurse
            } else {

                buf = readChunk.sync(filePath, 0, 500);
                _ext = undefined;
                if (fileType(buf)) _ext = fileType(buf).ext


                if (fileName.indexOf('.') > -1) {
                    fileSplit = fileName.split('.');
                    _extName = fileSplit[fileSplit.length - 1];
                } else {
                    _extName = undefined;
                }

                // console.log(_ext);

                switch (_ext) {
                    case 'jpg':
                        jpgArr.push({
                            dir: _dir + '/',
                            fileName: fileName,
                            ext: _ext,
                            extName: _extName
                        });
                        break;
                    case 'png':
                        pngArr.push({
                            dir: _dir + '/',
                            fileName: fileName,
                            ext: _ext,
                            extName: _extName
                        });
                        break;
                    case 'pdf':
                        pdfArr.push({
                            dir: _dir + '/',
                            fileName: fileName,
                            ext: _ext,
                            extName: _extName
                        });
                        break;
                    case 'psd':
                        psdArr.push({
                            dir: _dir + '/',
                            fileName: fileName,
                            ext: _ext,
                            extName: _extName
                        });
                        break;
                    case 'xml':
                        if (_extName === 'svg') {
                            svgArr.push({
                                dir: _dir + '/',
                                fileName: fileName,
                                ext: _ext,
                                extName: _extName
                            });
                        } else if (_extName === 'svgph') {
                            svgphArr.push({
                                dir: _dir + '/',
                                fileName: fileName,
                                ext: _ext,
                                extName: _extName
                            });
                        }
                        break;
                    case 'gif':
                        gifArr.push({
                            dir: _dir + '/',
                            fileName: fileName,
                            ext: _ext,
                            extName: _extName
                        });
                        break;
                    case 'mp4' || 'mov' || 'avi' || 'mkv':
                        vidArr.push({
                            dir: _dir + '/',
                            fileName: fileName,
                            ext: _ext,
                            extName: _extName
                        });
                        break;
                    default:
                        otherFilesArr.push({
                            dir: _dir + '/',
                            fileName: fileName,
                            ext: _ext,
                            extName: _extName
                        });
                }
            }
        }
    }
    fromDir(src);

    var _listObj = {
        "jpg": 		jpgArr,
        "png":	 	pngArr,
        "pdf": 		pdfArr,
        "svg": 		svgArr,
        "svgph": 	svgphArr,
        "psd": 		psdArr,
        "gif":	 	gifArr,
        "vid": 		vidArr,
        "other": 	otherFilesArr
    };

    return _listObj
}